<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Webhook n8n</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #005a9e;
        }
        pre {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f48771;
        }
        .warning {
            color: #dcdcaa;
        }
        input {
            padding: 8px;
            width: 300px;
            margin: 10px 0;
            background: #252526;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Webhook n8n</h1>
        <p>Cet outil teste la connexion avec ton webhook n8n et affiche la r√©ponse.</p>

        <label>URL du webhook:</label>
        <input type="text" id="webhookUrl" value="https://n8n-ou5ygldozq-od.a.run.app/webhook-test/form-data">

        <label>Token:</label>
        <input type="text" id="token" value="test123">

        <br>
        <button onclick="testWebhook()">üöÄ Tester le webhook</button>
        <button onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>

        <h2>üìã Logs</h2>
        <pre id="logs"></pre>

        <h2>üì¶ R√©ponse JSON</h2>
        <pre id="response"></pre>

        <h2>‚úÖ Validation</h2>
        <pre id="validation"></pre>
    </div>

    <script>
        const logsEl = document.getElementById('logs');
        const responseEl = document.getElementById('response');
        const validationEl = document.getElementById('validation');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logsEl.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span>\n`;
        }

        function clearLogs() {
            logsEl.innerHTML = '';
            responseEl.innerHTML = '';
            validationEl.innerHTML = '';
        }

        async function testWebhook() {
            clearLogs();

            const webhookUrl = document.getElementById('webhookUrl').value;
            const token = document.getElementById('token').value;
            const fullUrl = `${webhookUrl}?token=${token}`;

            log(`üîó URL compl√®te: ${fullUrl}`);
            log('üì° Envoi de la requ√™te GET...');

            try {
                const startTime = Date.now();
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const duration = Date.now() - startTime;
                log(`‚è±Ô∏è Temps de r√©ponse: ${duration}ms`);
                log(`üìä Status HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üîë Content-Type: ${response.headers.get('content-type')}`);

                if (!response.ok) {
                    log(`‚ùå Erreur HTTP: ${response.status}`, 'error');
                    const text = await response.text();
                    responseEl.textContent = text;
                    return;
                }

                // Lire la r√©ponse comme texte d'abord
                const rawText = await response.text();
                log(`üìÑ Taille de la r√©ponse: ${rawText.length} caract√®res`);

                // Afficher la r√©ponse brute
                responseEl.textContent = rawText;

                // Tenter de parser le JSON
                try {
                    const data = JSON.parse(rawText);
                    log('‚úÖ JSON pars√© avec succ√®s', 'success');

                    // Afficher le JSON format√©
                    responseEl.textContent = JSON.stringify(data, null, 2);

                    // Valider la structure
                    validateStructure(data);

                } catch (parseError) {
                    log(`‚ùå Erreur de parsing JSON: ${parseError.message}`, 'error');
                    validationEl.innerHTML = `<span class="error">Le webhook ne retourne pas un JSON valide.</span>`;
                }

            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');

                if (error.message.includes('Failed to fetch')) {
                    validationEl.innerHTML = `
<span class="error">‚ùå Impossible de se connecter au webhook.</span>

Causes possibles:
1. Probl√®me CORS - Le serveur n8n doit autoriser les requ√™tes depuis ton domaine
2. URL incorrecte
3. Webhook n8n d√©sactiv√©

Solution CORS:
Dans n8n, ajoute un node "Set Headers" avant le "Respond to Webhook":
{
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type"
}`;
                }
            }
        }

        function validateStructure(data) {
            let validation = '';
            let isValid = true;

            validation += '<span class="success">‚úÖ Structure du JSON:</span>\n\n';

            // V√©rifier contractId
            if (data.contractId) {
                validation += `‚úÖ contractId: "${data.contractId}"\n`;
            } else {
                validation += '<span class="warning">‚ö†Ô∏è contractId manquant (optionnel)</span>\n';
            }

            // V√©rifier sections
            if (!data.sections) {
                validation += '<span class="error">‚ùå ERREUR: "sections" manquant</span>\n';
                isValid = false;
            } else if (!Array.isArray(data.sections)) {
                validation += '<span class="error">‚ùå ERREUR: "sections" doit √™tre un tableau</span>\n';
                isValid = false;
            } else if (data.sections.length === 0) {
                validation += '<span class="error">‚ùå ERREUR: "sections" est vide</span>\n';
                isValid = false;
            } else {
                validation += `‚úÖ sections: ${data.sections.length} section(s) trouv√©e(s)\n\n`;

                // Valider chaque section
                data.sections.forEach((section, index) => {
                    validation += `üìÇ Section ${index + 1}:\n`;

                    if (!section.id) {
                        validation += '  <span class="error">‚ùå "id" manquant</span>\n';
                        isValid = false;
                    } else {
                        validation += `  ‚úÖ id: "${section.id}"\n`;
                    }

                    if (!section.title) {
                        validation += '  <span class="error">‚ùå "title" manquant</span>\n';
                        isValid = false;
                    } else {
                        validation += `  ‚úÖ title: "${section.title}"\n`;
                    }

                    if (!section.fields) {
                        validation += '  <span class="error">‚ùå "fields" manquant</span>\n';
                        isValid = false;
                    } else if (!Array.isArray(section.fields)) {
                        validation += '  <span class="error">‚ùå "fields" doit √™tre un tableau</span>\n';
                        isValid = false;
                    } else if (section.fields.length === 0) {
                        validation += '  <span class="warning">‚ö†Ô∏è "fields" est vide</span>\n';
                    } else {
                        validation += `  ‚úÖ fields: ${section.fields.length} champ(s)\n`;

                        // Valider les champs
                        section.fields.forEach((field, fieldIndex) => {
                            if (!field.name) {
                                validation += `    <span class="error">‚ùå Champ ${fieldIndex + 1}: "name" manquant</span>\n`;
                                isValid = false;
                            }
                            if (!field.label) {
                                validation += `    <span class="error">‚ùå Champ ${fieldIndex + 1}: "label" manquant</span>\n`;
                                isValid = false;
                            }
                            if (!field.type) {
                                validation += `    <span class="error">‚ùå Champ ${fieldIndex + 1}: "type" manquant</span>\n`;
                                isValid = false;
                            }
                        });
                    }

                    validation += '\n';
                });
            }

            if (isValid) {
                validation += '\n<span class="success">üéâ Structure valide ! Le formulaire devrait fonctionner.</span>';
            } else {
                validation += '\n<span class="error">‚ùå Structure invalide. Corrige les erreurs ci-dessus.</span>';
            }

            validationEl.innerHTML = validation;
        }

        // Test automatique au chargement (optionnel)
        // testWebhook();
    </script>
</body>
</html>
